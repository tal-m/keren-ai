server {
  listen 4173;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # --- Important: allow cross-origin loading of module JS/CSS assets ---
  location /assets/ {
    # Preflight
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin "*" always;
      add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
      add_header Content-Length 0;
      add_header Content-Type "text/plain; charset=utf-8";
      return 204;
    }

    try_files $uri =404;

    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
  }

  # Allow loader script too (not strictly required, but keeps behavior consistent)
  location = /keren-widget-loader.js {
    # Preflight
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin "*" always;
      add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
      add_header Content-Length 0;
      add_header Content-Type "text/plain; charset=utf-8";
      return 204;
    }

    try_files $uri =404;

    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
  }

  # SPA fallback for the main app (doesn't affect /assets/ because of try_files above)
  location / {
    try_files $uri $uri/ /index.html;
  }
}
