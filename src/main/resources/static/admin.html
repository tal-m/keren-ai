<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ניהול - Keren-AI</title>
    <link rel="stylesheet" href="/chat-widget.css">
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        .tabs { display: flex; background: #ffffff; border-bottom: 1px solid #ddd; }
        .tab { padding: 12px 18px; cursor: pointer; border: none; background: transparent; font-weight: bold; color: #333; }
        .tab.active { border-bottom: 3px solid #28a745; color: #28a745; }
        #main { display: flex; flex-direction: column; flex: 1; }

        #info-view, #history-view { flex: 1; display: none; }
        #info-view.active, #history-view.active { display: flex; flex-direction: column; }

        /* Info styles copied from index.html */
        #info-toolbar { display:flex; gap:8px; padding:12px; align-items:center; border-bottom:1px solid #eee; background:white; }
        #chunks-list { padding: 16px; overflow-y: auto; display:flex; flex-direction:column; gap:12px; }
        .chunk-item { background:white; padding:12px; border-radius:8px; display:flex; align-items:center; justify-content:space-between; gap:12px; border:1px solid #e6e6e6; }
        .chunk-text { flex:1; white-space:pre-wrap; }
        .chunk-meta { color:#666; font-size:0.9rem; margin-left:8px; }
        .small-btn { padding:6px 10px; background:#dc3545; border:none; color:white; border-radius:6px; cursor:pointer; }
        .edit-btn { padding:6px 10px; background:#ffc107; border:none; color:#222; border-radius:6px; cursor:pointer; }
        .add-btn { background:#007bff }
        #add-form { display:none; padding:12px; background:white; border-top:1px solid #eee; }

        /* History styles */
        .metric-item { background:white; padding:12px; border-radius:8px; border:1px solid #e6e6e6; }
        .metric-item .field-row { display: grid; grid-template-columns: 160px 1fr; gap: 12px; padding: 10px 0; align-items: start; border-bottom: 1px solid #f0f0f0; }
        .metric-item .field-row:last-child { border-bottom: none; }
        .metric-item .field-row:nth-child(odd) { background: #fbfcfd; }
        .metric-item .field-row:hover { background: #f7fff7; }
        .field-label { font-weight: 600; min-width: 140px; color: #333; }
        .field-value { color: #222; white-space: pre-wrap; }

        /* Chat iframe styles */
        #chat-iframe { width: 100%; height: 480px; border: 1px solid #ddd; border-radius: 8px; display: none; }
        #chat-toggle { margin-left: 12px; padding: 8px 12px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer; }

    </style>
</head>
<body>

<div class="tabs">
    <button class="tab active" id="tab-info">מידע</button>
    <button class="tab" id="tab-history">היסטוריית שאלות</button>
    <div style="margin-left:auto;padding:12px;display:flex;align-items:center;gap:8px;">
        <!-- Home link removed: admin page is the single entry point -->
    </div>
</div>

<div id="main">

    <div id="info-view" class="active">
        <div id="info-toolbar">
            <button id="refresh-chunks">רענן</button>
            <button id="show-add" class="add-btn">הוסף קטע +</button>
            <div style="flex:1"></div>
            <div class="chunk-meta">רשימת קטעים במאגר</div>
        </div>

        <div id="add-form">
            <label>תוכן:</label>
            <textarea id="new-content"></textarea>
            <div>
                <label>תג:</label>
                <input type="text" id="new-tag" placeholder="תג (לדוגמה: מטרה, דרישות)">
            </div>
            <div class="form-actions">
                <button id="add-submit" class="add-btn">שמור</button>
                <button id="add-cancel">ביטול</button>
            </div>
        </div>

        <div id="chunks-list"></div>
    </div>

    <div id="history-view">
        <div id="history-toolbar" style="padding:12px;display:flex;align-items:center;gap:8px;background:white;border-bottom:1px solid #eee;">
            <button id="refresh-metrics">רענן</button>
            <div style="flex:1"></div>
            <div class="chunk-meta">היסטוריית שאלות וסטטיסטיקות</div>
        </div>

        <div id="metrics-summary" style="padding:12px;background:white;border-bottom:1px solid #eee;display:flex;gap:16px;flex-wrap:wrap;">
            <!-- summary injected here -->
        </div>

        <div id="metrics-list" style="padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;">
            <!-- metrics list injected here -->
        </div>
    </div>
</div>


<script src="/keren-chat-init.js"></script>

<script>
    // Tabs
    document.getElementById('tab-info').addEventListener('click', () => showTab('info'));
    document.getElementById('tab-history').addEventListener('click', () => showTab('history'));

    function showTab(name) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#info-view, #history-view').forEach(v => v.classList.remove('active'));
        if (name === 'info') {
            document.getElementById('tab-info').classList.add('active');
            document.getElementById('info-view').classList.add('active');
            loadChunks();
        } else if (name === 'history') {
            document.getElementById('tab-history').classList.add('active');
            document.getElementById('history-view').classList.add('active');
            loadMetrics();
        }
    }

    // --- Info tab functionality (copied from index.html) ---
    const chunksList = document.getElementById('chunks-list');
    const refreshBtn = document.getElementById('refresh-chunks');
    const showAddBtn = document.getElementById('show-add');
    const addForm = document.getElementById('add-form');
    const addCancel = document.getElementById('add-cancel');
    const addSubmit = document.getElementById('add-submit');

    refreshBtn.addEventListener('click', loadChunks);
    showAddBtn.addEventListener('click', () => { addForm.style.display = 'block'; });
    addCancel.addEventListener('click', () => { addForm.style.display = 'none'; });
    addSubmit.addEventListener('click', addChunk);

    async function loadChunks() {
        chunksList.innerHTML = ''; // clear
        try {
            const res = await fetch('/api/v1/keren-ai/chunks');
            if (!res.ok) throw new Error('Failed to fetch chunks');
            const docs = await res.json();

            if (!Array.isArray(docs) || docs.length === 0) {
                chunksList.innerHTML = '<div style="padding:16px;color:#666">אין קטעים במאגר</div>';
                return;
            }

            docs.forEach(doc => {
                const id = doc.id || doc.documentId || (doc.metadata && doc.metadata.id) || null;
                const text = doc.text || doc.content || doc.payload || JSON.stringify(doc);
                let tag = null;
                if (doc.metadata) {
                    if (typeof doc.metadata === 'object') {
                        tag = doc.metadata.tag || doc.metadata['tag'];
                    } else if (typeof doc.metadata === 'string') {
                        try { const m = JSON.parse(doc.metadata); tag = m.tag; } catch(e){}
                    }
                }

                const item = document.createElement('div');
                item.className = 'chunk-item';

                const left = document.createElement('div');
                left.style.display = 'flex';
                left.style.flexDirection = 'column';
                left.style.gap = '6px';
                const textDiv = document.createElement('div');
                textDiv.className = 'chunk-text';
                textDiv.innerText = text;
                const metaDiv = document.createElement('div');
                metaDiv.className = 'chunk-meta';
                metaDiv.innerText = tag ? `תג: ${tag}` : (id ? `id: ${id}` : '');

                left.appendChild(textDiv);
                left.appendChild(metaDiv);

                const right = document.createElement('div');
                right.style.display = 'flex';
                right.style.gap = '8px';
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.innerText = 'ערוך';
                if (!id) editBtn.disabled = true;
                editBtn.addEventListener('click', () => {
                    if (!id) return alert('לא ניתן לערוך פריט ללא id');
                    enterEditMode(item, doc, id);
                });

                const delBtn = document.createElement('button');
                delBtn.className = 'small-btn';
                delBtn.innerText = 'מחק';
                if (!id) delBtn.disabled = true;
                delBtn.addEventListener('click', () => {
                    if (!id) return alert('לא ניתן למחוק פריט ללא id');
                    if (!confirm('למחוק קטע זה?')) return;
                    deleteChunk(id);
                });

                right.appendChild(editBtn);
                right.appendChild(delBtn);

                item.appendChild(left);
                item.appendChild(right);

                chunksList.appendChild(item);
            });

        } catch (err) {
            chunksList.innerHTML = '<div style="padding:16px;color:#c00">שגיאה בטעינת הקטעים</div>';
            console.error(err);
        }
    }

    function enterEditMode(itemElement, doc, id) {
        const left = itemElement.querySelector('div');
        const textDiv = left.querySelector('.chunk-text');
        const metaDiv = left.querySelector('.chunk-meta');

        const originalText = textDiv.innerText;
        const originalMeta = metaDiv.innerText;

        const textarea = document.createElement('textarea');
        textarea.style.width = '100%';
        textarea.style.minHeight = '80px';
        textarea.value = doc.text || doc.content || '';

        const tagInput = document.createElement('input');
        tagInput.type = 'text';
        tagInput.value = (doc.metadata && (doc.metadata.tag || (typeof doc.metadata === 'string' ? (() => { try { return JSON.parse(doc.metadata).tag } catch(e){ return '' } })() : ''))) || '';
        tagInput.placeholder = 'תג (אופציונלי)';

        left.innerHTML = '';
        left.appendChild(textarea);
        left.appendChild(tagInput);

        const right = itemElement.querySelector('div:nth-child(2)');
        right.innerHTML = '';

        const saveBtn = document.createElement('button');
        saveBtn.className = 'add-btn';
        saveBtn.innerText = 'שמור';
        saveBtn.addEventListener('click', () => saveEdit(id, itemElement, textarea, tagInput));

        const cancelBtn = document.createElement('button');
        cancelBtn.innerText = 'ביטול';
        cancelBtn.addEventListener('click', () => cancelEdit(itemElement, originalText, originalMeta));

        right.appendChild(saveBtn);
        right.appendChild(cancelBtn);
    }

    function cancelEdit(itemElement, originalText, originalMeta) {
        const left = itemElement.querySelector('div');
        left.innerHTML = '';
        const textDiv = document.createElement('div');
        textDiv.className = 'chunk-text';
        textDiv.innerText = originalText;
        const metaDiv = document.createElement('div');
        metaDiv.className = 'chunk-meta';
        metaDiv.innerText = originalMeta;
        left.appendChild(textDiv);
        left.appendChild(metaDiv);

        loadChunks();
    }

    async function saveEdit(id, itemElement, textarea, tagInput) {
        const content = textarea.value.trim();
        const tag = tagInput.value.trim();
        if (!content) return alert('יש להזין תוכן לקטע');

        const payload = { content: content, tag: tag };
        try {
            const res = await fetch('/api/v1/keren-ai/chunks/' + encodeURIComponent(id), {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('update failed');
            await loadChunks();
        } catch (err) {
            alert('שגיאה בעדכון הקטע');
            console.error(err);
        }
    }

    async function deleteChunk(id) {
        try {
            const res = await fetch('/api/v1/keren-ai/chunks/' + encodeURIComponent(id), { method: 'DELETE' });
            if (!res.ok) throw new Error('delete failed');
            await loadChunks();
        } catch (err) {
            alert('שגיאה בביצוע המחיקה');
            console.error(err);
        }
    }

    async function addChunk() {
        const content = document.getElementById('new-content').value.trim();
        const tag = document.getElementById('new-tag').value.trim();
        if (!content) return alert('יש להזין תוכן לקטע');

        const payload = { content: content, tag: tag };
        try {
            const res = await fetch('/api/v1/keren-ai/chunks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('add failed');
            document.getElementById('new-content').value = '';
            document.getElementById('new-tag').value = '';
            addForm.style.display = 'none';
            await loadChunks();
        } catch (err) {
            alert('שגיאה ביצירת הקטע');
            console.error(err);
        }
    }

    // History tab functionality
    const refreshMetricsBtn = document.getElementById('refresh-metrics');
    const metricsList = document.getElementById('metrics-list');
    const metricsSummary = document.getElementById('metrics-summary');
    if (refreshMetricsBtn) refreshMetricsBtn.addEventListener('click', loadMetrics);

    async function loadMetrics() {
        metricsList.innerHTML = '';
        metricsSummary.innerHTML = '';
        try {
            const sres = await fetch('/api/v1/keren-ai/metrics/summary');
            if (!sres.ok) throw new Error('Failed to fetch metrics summary');
            const summary = await sres.json();

            metricsSummary.appendChild(renderSummaryItem('ממוצע טוקנים שאלה', summary.avgUserTokens));
            metricsSummary.appendChild(renderSummaryItem('ממוצע טוקנים תשובה', summary.avgAiTokens));
            metricsSummary.appendChild(renderSummaryItem('ממוצע טוקנים סה"כ', summary.avgTotalTokens));
            metricsSummary.appendChild(renderSummaryItem('סך כל אינטראקציות', summary.totalInteractions));

            const mres = await fetch('/api/v1/keren-ai/metrics');
            if (!mres.ok) throw new Error('Failed to fetch metrics');
            const metrics = await mres.json();

            if (!Array.isArray(metrics) || metrics.length === 0) {
                metricsList.innerHTML = '<div style="padding:16px;color:#666">אין נתונים</div>';
                return;
            }

            metrics.forEach(m => {
                const item = document.createElement('div');
                item.className = 'metric-item';

                const fields = [
                    { label: 'שאלה', value: m.userInput },
                    { label: 'תשובת בוט', value: m.aiResponse },
                    { label: 'נוצר ב', value: m.createdAt },
                    { label: 'טוקנים שאלה', value: m.userTokens },
                    { label: 'טוקנים תשובה', value: m.aiTokens },
                    { label: 'טוקנים סה"כ', value: m.totalTokens }
                ];

                fields.forEach(f => {
                    const row = document.createElement('div');
                    row.className = 'field-row';

                    const name = document.createElement('div');
                    name.className = 'field-label';
                    name.innerText = f.label + ':';

                    const val = document.createElement('div');
                    val.className = 'field-value';
                    const valueText = (f.value !== null && f.value !== undefined && String(f.value).trim() !== '') ? f.value : '-';
                    val.innerText = valueText;

                    row.appendChild(name);
                    row.appendChild(val);
                    item.appendChild(row);
                });

                metricsList.appendChild(item);
            });

        } catch (err) {
            metricsList.innerHTML = '<div style="padding:16px;color:#c00">שגיאה בטעינת ההיסטוריה</div>';
            console.error(err);
        }
    }

    function renderSummaryItem(title, value) {
        const box = document.createElement('div');
        box.style.minWidth = '160px';
        box.style.padding = '8px';
        box.style.borderRadius = '6px';
        box.style.background = 'white';
        box.style.border = '1px solid #eee';
        box.innerHTML = `<div style="font-size:0.9rem;color:#666">${title}</div><div style="font-weight:bold;margin-top:6px">${value ?? '-'} </div>`;
        return box;
    }

    // Initialize
    showTab('info');

</script>
</body>
</html>
