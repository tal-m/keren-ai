#!/bin/bash

# Stop script on first error
set -e

# Configuration
DATA_DIR="./keren_ai_data"
IMAGE_NAME="ghcr.io/postgresml/postgresml:2.7.12"
TEMP_CONTAINER_NAME="temp_pgml_installer"

echo "--- PostgresML Setup Script ---"

# 1. Check if data directory already exists to prevent accidental overwrites
if [ -d "$DATA_DIR" ]; then
    echo "âš ï¸  Directory '$DATA_DIR' already exists."
    echo "   Skipping initialization to avoid overwriting existing database data."
    echo "   If this is a fresh install and you want to reset, delete '$DATA_DIR' and re-run this script."
else
    echo "ðŸš€ Initializing fresh data directory..."

    # 2. Run a temporary container in the background
    #    We do not mount any volumes yet; we let the container create its internal structure.
    echo "   -> Starting temporary container to generate initial files..."
    docker run -d --name $TEMP_CONTAINER_NAME $IMAGE_NAME > /dev/null

    # 3. Wait a moment for the entrypoint to initialize file structure
    echo "   -> Waiting for internal initialization..."
    sleep 5

    # 4. Copy the initialized data from the container to the host
    #    This preserves the exact permissions (UID/GID) required by Postgres
    echo "   -> Copying database files to host ($DATA_DIR)..."
    docker cp -a $TEMP_CONTAINER_NAME:/var/lib/postgresql $DATA_DIR
    # Fix ownership problems
    chown -R 101:101 ${DATA_DIR}

    # 5. Clean up the temporary container
    echo "   -> Removing temporary container..."
    docker rm -f $TEMP_CONTAINER_NAME > /dev/null
    
    echo "âœ… Data directory setup complete."
fi

echo "--- Setup Finished ---"
echo "1. Ensure you have a .env file with SPRING_DATASOURCE_USERNAME and SPRING_DATASOURCE_PASSWORD set."
echo "2. Run: docker compose up -d"
